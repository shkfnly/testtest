"use strict";var app=angular.module("urbinsight",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ui.router","ngSanitize","ngTouch","ui.bootstrap","urbinsight.services"]);app.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/#"),c.interceptors.push("TokenIntercept"),a.state("app",{views:{header:{templateUrl:"views/partials/_header.html",controller:"HeaderCtrl"}}}).state("app.main",{"abstract":!0,views:{"container@":{templateUrl:"views/main.html"}}}).state("app.main.homepage",{url:"/",controller:"MainCtrl",views:{landing:{templateUrl:"views/homepage/landing.html"},pilotProcess:{templateUrl:"views/homepage/pilotProcess.html",controller:"ProcessCtrl"},pilots:{templateUrl:"views/homepage/pilots.html",controller:"PilotsCtrl"},layerIntro:{templateUrl:"views/homepage/layerIntro.html"},contact:{templateUrl:"views/homepage/contact.html"}}}).state("app.about",{url:"/about",views:{"container@":{templateUrl:"views/about.html",controller:"AboutCtrl"}}}).state("app.signup",{url:"/signup",views:{"container@":{templateUrl:"views/signup.html",controller:"SignupCtrl"}}}).state("app.compass",{url:"/compass",views:{"container@":{templateUrl:"views/compass.html",controller:"CompassCtrl"}},access:{requiredLogin:!0}}).state("app.city",{views:{"container@":{templateUrl:"views/cities/cityDefault.html",controller:"CitiesCtrl"}}}).state("app.city.pilot",{url:"/dashboard/:city_name",views:{mapModal:{templateUrl:"views/cities/mapmodal.html",controller:"MapModalCtrl"}}}).state("app.city.pilot.umis",{views:{umisTabs:{templateUrl:"views/cities/umisTabs.html"}}}).state("app.city.pilot.umis.energy",{views:{energy:{templateUrl:"views/cities/umisResource.html",controller:"umisResourceCtrl"}},params:{type:"energy"}}).state("app.city.pilot.umis.water",{views:{water:{templateUrl:"views/cities/umisResource.html",controller:"umisResourceCtrl"}},params:{type:"water"}}).state("app.city.pilot.umis.materials",{views:{materials:{templateUrl:"views/cities/umisResource.html",controller:"umisResourceCtrl"}},params:{type:"materials"}}).state("app.city.pilot.umis.mobility",{views:{mobility:{templateUrl:"views/cities/umisResource.html",controller:"umisResourceCtrl"}},params:{type:"mobility"}}).state("app.city.pilot.survey",{views:{survey:{templateUrl:"views/cities/survey.html"}}}).state("app.city.pilot.assessments",{views:{assessments:{templateUrl:"views/cities/assessments/assessments.html"}}}).state("app.city.pilot.assessments.air",{views:{air:{templateUrl:"views/cities/assessments/air.html"}}}).state("app.city.pilot.assessments.water",{views:{water:{templateUrl:"views/cities/assessments/water.html"}}}).state("app.city.pilot.assessments.soil",{views:{soil:{templateUrl:"views/cities/assessments/soil.html"}}}).state("app.city.pilot.basedata",{views:{basedata:{templateUrl:"views/cities/basedata.html"}}}).state("app.dashboard",{url:"/dashboard",views:{"container@":{templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}}}).state("app.login",{url:"/login",views:{"container@":{templateUrl:"views/login.html",controller:"LoginCtrl"}}})}]).run(["$rootScope","$window","$location","AuthFactory",function(a,b,c,d){d.check(),a.$on("$routeChangeStart",function(a,e,f){console.log("nextRoute:"+e),console.log("currentRoute:"+f),console.log("nextRoute.access:"+e.access),console.log("nextRoute.access.requiredLogin:"+e.access.requiredLogin),e.access&&e.access.requiredLogin&&!d.isLogged?c.path("/login"):(d.user||(d.user=b.sessionStorage.user),d.userRole||(d.userRole=b.sessionStorage.userRole))}),a.$on("$routeChangeSuccess",function(b,e,f){a.showMenu=d.loggedStatus(),a.role=d.userRole,d.isLogged===!0&&"/login"===c.path()&&c.path("/")})}]),angular.module("urbinsight").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("SignupCtrl",["$scope","$location","$rootScope","$http","AuthFactory",function(a,b,c,d,e){var f,g;a.signup=g={},g.user=f={},g.submit=function(){if(!(f.username&&f.email&&f.password1&&f.password2))return window.alert("Please fill out all fields."),!1;if(f.password1!==f.password2)return window.alert("Your passwords must match."),!1;var a=d.post("/signup/",f);a.success(function(a){b.path("/dashboard"),c.currentUser=a.client,console.log(a),c.showMenu=!0}),a.error(function(a){console.log("error")})},a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("DashboardCtrl",["$scope","$location","$stateParams",function(a,b,c){a.addMap=function(){var b=window.L;b.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",a.map=b.mapbox.map("dashboardMap","urbinsight.l906cd2j",{zoomControl:!0,minZoom:3}).setView([0,0],3)},a.addMap(),a.$stateParams=c}]),angular.module("urbinsight").controller("ProcessCtrl",["$scope",function(a){a.addMap=function(){var a=window.L;a.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg";var b=a.mapbox.map("pilotProcessMap","urbinsight.jh7lje5c",{zoomControl:!1}).setView([0,0],2);b.touchZoom.disable(),b.doubleClickZoom.disable(),b.scrollWheelZoom.disable()},a.addMap(),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("PilotsCtrl",["$scope",function(a){a.imgLoader=function(){window.$(document).ready(function(){window.$("#medellin").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")}),window.$("#cairo").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")}),window.$("#casablanca").hover(function(){window.$(this).removeClass("darken")},function(){window.$(this).addClass("darken")})})},a.imgLoader(),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("CitiesCtrl",["$scope","$location","$http","Cities",function(a,b,c,d){var e;a.L=e=window.L,e.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",a.gridLayers=[],a.gridControls=[];var f=b.path().split("/")[2];a.overlayAddCtrl=function(b){a.gridLayer=e.mapbox.gridLayer(b.layer._tilejson.id),a.map.addLayer(a.gridLayer),a.gridControl=e.mapbox.gridControl(a.gridLayer),a.map.addControl(a.gridControl)},a.overlayRmvCtrl=function(b){for(var c=0;c<a.gridLayers.length;c++)if(a.gridLayers[c]._tilejson.id===b.layer._tilejson.id){a.map.removeLayer(a.gridLayers[c]),a.map.removeControl(a.gridControls[c]),a.gridLayers.splice(c,1),a.gridControls.splice(c,1);break}},a.additonalLayers=function(b){var c=!0,d={};return angular.forEach(b,function(b,f){c?(d[f]=e.mapbox.tileLayer(b).addTo(a.map),a.gridLayer=e.mapbox.gridLayer(b),a.gridLayers.push(a.gridLayer),a.map.addLayer(a.gridLayer),a.gridControl=e.mapbox.gridControl(a.gridLayer),a.gridControls.push(a.gridControl),a.map.addControl(a.gridControl),c=!1):d[f]=e.mapbox.tileLayer(b)}),d},a.addLayerControl=function(b){e.control.layers({"Base Map":e.mapbox.tileLayer("urbinsight.1114602d").addTo(a.map),"Satellite Map":e.mapbox.tileLayer("urbinsight.l906cd2j"),"Toner Map":e.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'}),"Watercolor Map":e.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'})},b).addTo(a.map)},a.renderMap=function(b){a.city=b,a.map=e.mapbox.map("cityMap",{zoomControl:!0,minZoom:3,drawControl:!0}).setView([b.lat,b.lon],12);var c=e.featureGroup().addTo(a.map);a.layerDefs=b.layerDefinitions,a.addLayerControl(a.additonalLayers(b.layers)),a.map.on("overlayadd",a.overlayAddCtrl),a.map.on("overlayremove",a.overlayRmvCtrl),a.map.on("draw:created",function(a){var b=a.layerType,c=a.layer;console.log(b),console.log(c)}),a.map.on("dragend",function(a){console.log(a)});new e.Control.Draw({edit:{featureGroup:c}}).addTo(a.map);a.map.on("draw:created",function(a){c.addLayer(a.layer)})},a.linesAdded=[],a.drawFlows=function(b){var d=c.get("/data/relation/"+b.id),f=a;d.success(function(a,b){angular.forEach(f.linesAdded,function(a){f.map.removeLayer(a)}),angular.forEach(a,function(a){f.linesAdded.push(e.polyline(a,{color:"teal",opacity:1,weight:10}).addTo(f.map))})}),d.error(function(a,b){})},a.renderNodes=function(b){a.map;angular.forEach(b,function(b,c){var f=new e.MarkerClusterGroup({iconCreateFunction:function(a){return e.mapbox.marker.icon({"marker-symbol":a.getChildCount(),"marker-color":d.allColors()[c]})}});angular.forEach(b,function(b){var e=parseFloat(b.lat),g=parseFloat(b.lng),h=a.L.marker([e,g],{icon:a.L.mapbox.marker.icon({"marker-size":"small","marker-color":d.allColors()[c]})}).bindPopup("<p>Type: "+c+"</p><p>Id: "+b.id+"</p>").on("click",function(){a.drawFlows(b)});f.addLayer(h),a.markers=f}),a.map.addLayer(f)})},d.fetchCity(f,a.renderMap),d.getNodes(f,a.renderNodes)}]),angular.module("urbinsight").controller("CompassCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight").controller("MapModalCtrl",["$scope",function(a){$("#plusclick").on("click",function(a){$("#plusclick").toggleClass("opened"),$("#mapModal").toggleClass("hoveredon"),$("#modalbar").toggleClass("shown")})}]),angular.module("urbinsight.services",[]).factory("Cities",["$http",function(a){var b={source:"#9c89cc",upstream:"#7ec9b1",demand:"#3ca0d3",downstream:"#fa946e",sink:"#f1f075"},c=window.L;return c.mapbox.accessToken="pk.eyJ1IjoidXJiaW5zaWdodCIsImEiOiJIbG1xUDBBIn0.o2RgJkl1-wCO7yyG7Khlzg",{fetchCity:function(b,c){var d=a.get("/data/city/"+b);d.success(function(a,b){return c(a)})},createCity:function(b){var c=a.post("/data/city/"+b);c.success(function(a,b){console.log("createcity ran in service")})},getNodes:function(b,c){var d=a.get("/data/label/"+b);d.success(function(a,b){return c(a)})},allColors:function(){return b}}}]),angular.module("urbinsight").controller("ResourceTabCtrl",["$scope",function(a){a.renderLine=function(a){var b={top:20,right:80,bottom:30,left:50},c=430-b.left-b.right,d=250-b.top-b.bottom,e=d3.time.format("%Y%m%d").parse,f=d3.time.scale().range([0,c]),g=d3.scale.linear().range([d,0]),h=d3.scale.category10(),i=d3.svg.axis().scale(f).orient("bottom"),j=d3.svg.axis().scale(g).orient("left"),k=d3.svg.line().interpolate("basis").x(function(a){return f(a.date)}).y(function(a){return g(a.temperature)}),l=d3.select("#line").append("svg").attr("width",c+b.left+b.right).attr("height",d+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");h.domain(d3.keys(a[0]).filter(function(a){return"date"!==a})),a.forEach(function(a){a.date=e(a.date)});var m=h.domain().map(function(b){return{name:b,values:a.map(function(a){return{date:a.date,temperature:+a[b]}})}});f.domain(d3.extent(a,function(a){return a.date})),g.domain([d3.min(m,function(a){return d3.min(a.values,function(a){return a.temperature})}),d3.max(m,function(a){return d3.max(a.values,function(a){return a.temperature})})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Temperature (ºF)");var n=l.selectAll(".city").data(m).enter().append("g").attr("class","city");n.append("path").attr("class","line").attr("d",function(a){return k(a.values)}).style("stroke",function(a){return h(a.name)}),n.append("text").datum(function(a){return{name:a.name,value:a.values[a.values.length-1]}}).attr("transform",function(a){return"translate("+f(a.value.date)+","+g(a.value.temperature)+")"}).attr("x",3).attr("dy",".35em").text(function(a){return a.name})},a.renderPie=function(a){{var b=function(a){a.x0=a.x,a.dx0=a.dx},c=200,d=200,e=Math.min(c,d)/2,f=d3.scale.category10(),g=d3.select("#viz").append("svg").attr("width",c).attr("height",d).append("g").attr("transform","translate("+c/2+","+.52*d+")"),h=d3.layout.partition().sort(null).size([2*Math.PI,e*e]).value(function(a){return 1}),i=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)});g.datum(a).selectAll("path").data(h.nodes).enter().append("path").attr("display",function(a){return a.depth?null:"none"}).attr("d",i).style("stroke","#fff").style("fill",function(a){return f((a.children?a:a.parent).name)}).style("fill-rule","evenodd").each(b)}d3.select(self.frameElement).style("height",d+"px")},a.fetchPieData=function(b){d3.json(b,function(b,c){a.data=c,a.renderPie(c)})},a.fetchLineData=function(b){d3.tsv(b,function(b,c){a.data=c,a.renderLine(c)})},a.fetchLineData("https://gist.githubusercontent.com/shkfnly/9ad173c4c972024521ec/raw/c4e8fc0369683d2706eebcaa28c75ff1a9206883/testdata.tsv"),a.fetchPieData("https://gist.githubusercontent.com/shkfnly/2da4667e9f654be9dfd0/raw/1e5746ae751bff323a8831a105f25fec3577b9fa/testdata.json"),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("urbinsight.services").factory("AuthFactory",["$window",function(a){var b=!1;return{check:function(){a.sessionStorage.token&&a.sessionStorage.user?b=!0:(b=!1,delete this.user)},loggedStatus:function(){return b},changeLoggedStatus:function(){b=!b}}}]).factory("UserAuthFactory",["$window","$location","$http","AuthFactory",function(a,b,c,d){return{login:function(a,b){return c.post("/login/",{username:a,password:b})},logout:function(){d.loggedStatus()&&(d.changeLoggedStatus(),delete d.user,delete d.userRole,delete a.sessionStorage.token,delete a.sessionStorage.user,delete a.sessionStorage.userRole,b.path("/"))}}}]).factory("TokenIntercept",["$q","$window",function(a,b){return{request:function(c){return c.headers=c.headers||{},b.sessionStorage.token&&(c.headers["X-Access-Token"]=b.sessionStorage.token,c.headers["X-Key"]=b.sessionStorage.user,c.headers["Content-Type"]="application/json"),c||a.when(c)},response:function(b){return b||a.when(b)}}}]),angular.module("urbinsight").controller("LoginCtrl",["$scope","$window","$rootScope","$location","UserAuthFactory","AuthFactory",function(a,b,c,d,e,f){var g,h;a.login=h={},h.user=g={},h.submit=function(){var a=g.username,h=g.password;void 0!==a&&void 0!==h?e.login(a,h).success(function(a){c.showMenu=!0,f.changeLoggedStatus(),f.user=a.user.username,f.userRole=a.user.role,b.sessionStorage.token=a.token,b.sessionStorage.user=a.user.username,b.sessionStorage.userRole=a.user.role,d.path("/")}).error(function(a){b.alert("Oops something went wrong!")}):b.alert("Invalid credentials")}}]),angular.module("urbinsight").controller("HeaderCtrl",["$scope","$rootScope","$state","$location","UserAuthFactory","AuthFactory",function(a,b,c,d,e,f){a.logout=function(){e.logout(),b.$broadcast("loginStateChange"),d.path("/")},b.$on("loginStateChange",function(){b.showMenu=f.loggedStatus()})}]),angular.module("urbinsight").controller("umisResourceCtrl",["$scope","$stateParams",function(a,b){a.renderLine=function(a){var b={top:20,right:80,bottom:30,left:50},c=430-b.left-b.right,d=250-b.top-b.bottom,e=d3.time.format("%Y%m%d").parse,f=d3.time.scale().range([0,c]),g=d3.scale.linear().range([d,0]),h=d3.scale.category10(),i=d3.svg.axis().scale(f).orient("bottom"),j=d3.svg.axis().scale(g).orient("left"),k=d3.svg.line().interpolate("basis").x(function(a){return f(a.date)}).y(function(a){return g(a.temperature)}),l=d3.select("#line").append("svg").attr("width",c+b.left+b.right).attr("height",d+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");h.domain(d3.keys(a[0]).filter(function(a){return"date"!==a})),a.forEach(function(a){a.date=e(a.date)});var m=h.domain().map(function(b){return{name:b,values:a.map(function(a){return{date:a.date,temperature:+a[b]}})}});f.domain(d3.extent(a,function(a){return a.date})),g.domain([d3.min(m,function(a){return d3.min(a.values,function(a){return a.temperature})}),d3.max(m,function(a){return d3.max(a.values,function(a){return a.temperature})})]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(i),l.append("g").attr("class","y axis").call(j).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Temperature (ºF)");var n=l.selectAll(".city").data(m).enter().append("g").attr("class","city");n.append("path").attr("class","line").attr("d",function(a){return k(a.values)}).style("stroke",function(a){return h(a.name)}),n.append("text").datum(function(a){return{name:a.name,value:a.values[a.values.length-1]}}).attr("transform",function(a){return"translate("+f(a.value.date)+","+g(a.value.temperature)+")"}).attr("x",3).attr("dy",".35em").text(function(a){return a.name})},a.renderPie=function(a){{var b=function(a){a.x0=a.x,a.dx0=a.dx},c=200,d=200,e=Math.min(c,d)/2,f=d3.scale.category10(),g=d3.select("#viz").append("svg").attr("width",c).attr("height",d).append("g").attr("transform","translate("+c/2+","+.52*d+")"),h=d3.layout.partition().sort(null).size([2*Math.PI,e*e]).value(function(a){return 1}),i=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)});g.datum(a).selectAll("path").data(h.nodes).enter().append("path").attr("display",function(a){return a.depth?null:"none"}).attr("d",i).style("stroke","#fff").style("fill",function(a){return f((a.children?a:a.parent).name)}).style("fill-rule","evenodd").each(b)}d3.select(self.frameElement).style("height",d+"px")},a.fetchPieData=function(b){d3.json(b,function(b,c){a.data=c,a.renderPie(c)})},a.fetchLineData=function(b){d3.tsv(b,function(b,c){a.data=c,a.renderLine(c)})},a.fetchLineData("https://gist.githubusercontent.com/shkfnly/9ad173c4c972024521ec/raw/c4e8fc0369683d2706eebcaa28c75ff1a9206883/testdata.tsv"),a.fetchPieData("https://gist.githubusercontent.com/shkfnly/2da4667e9f654be9dfd0/raw/1e5746ae751bff323a8831a105f25fec3577b9fa/testdata.json"),a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);